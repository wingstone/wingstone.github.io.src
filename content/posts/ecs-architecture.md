---
title: 'ECS Architecture'
date: 2020-09-10 14:38:33
tags: [engine,architecture]
published: true
hideInList: false
feature: 
isTop: false
---

ECS架构介绍
<!--more-->

## ECS架构介绍

**ECS** ，即 **Entity-Component-System（实体-组件-系统）** 的缩写，其模式遵循 **组合优于继承** 原则，游戏内的每一个基本单元都是一个 **实体** ，每个 **实体** 又由一个或多个 **组件** 构成，每个 **组件** 仅仅包含代表其特性的 **数据（即在组件中没有任何方法）** ，**系统** 便是来处理拥有一个或多个相同组件的实体集合的工具，其只拥有 **行为（即在系统中没有任何数据）** 。

**实体与组件是一个一对多的关系** ，实体拥有怎样的能力，完全是取决于其拥有哪些组件，通过动态添加或删除组件，可以在（游戏）运行时改变实体的行为。

## ECS详解

### 实体

实体是游戏中的一个独特物体，使用一个ID进行表示和标记；

### 组件

一个组件是一个数据的集合，不存在任何方法；一个经典的实现是使用 **继承（或实现）同一个基类（或接口）** ，这样就可以在运行时动态的添加和移除；

根据设计需求，有时在全局上下文中只有一个特殊的组件，这种组件一般称之为 **Singleton Component（单例组件）** ；

### 系统

系统便是ECS架构中用来 **处理游戏逻辑** 的部分。一个系统就是对拥有一个或多个相同组件的实体集合进行操作的工具，它只有行为，没有状态，即不存放任何数据。OW差不多拥有上百个系统；

由于代码逻辑分布于各个系统中，各个系统之间为了解耦又不能互相访问，那么如果有多个系统希望运行同样的逻辑，该如何解决，总不能把代码复制 N 份，放到各个系统之中。 **UtilityFunction（实用函数）** 便是用来解决这一问题的，它将被多个系统调用的方法单独提取出来，放到统一的地方，同系统一样， **UtilityFunction** 中不能存放状态，它应该是拥有各个方法的纯净集合。

## ECS架构优点

1. 性能优势：ECS带来的两大性能优势，就是cache友好，以及易于做多线程并行。
2. 数据与行为分离：修改方便，逻辑清晰；

## OOP（面向对象）架构

传统的很多游戏引擎是基于 **面向对象** 来设计的，游戏中的东西都是对象，每个对象有一个叫做 **Update** 的方法，框架 **遍历所有的对象** ，依次调用其 **Update** 方法。有些引擎甚至定义了多种 **Update** 方法，在同一帧的不同时机去调用。

## Unity引擎的架构

Unity的设计思想为 **基于组件** 的对象模型；**基于组件** 的对象模型就是把所有需要提供给游戏对象的基础功能都独立成单独的 **组件模块(Component)** ，一个具体的游戏对象可以将它需要的功能模块组合到一起使用。所有 **功能** 不再是父类中的接口，而变成子对象实例，为游戏对象提供服务。

在Unity中， **GameObject** 除了作为 **Component** 的容器之外，基本上没有其他功能。所有需要的功能都要通过 **组合Component** 来实现。虽然这些 **Component** 在物理上是完全并列的关系，但是他们之间还是会有一定的层次关系的。在设计一个游戏对象的具体功能时，组件一般会被分为三个层次。

1. **引擎的基础组件**：Unity本身提供的各种内部功能组件。比如渲染组件，物理组件，声音组件等等。
2. **模块功能脚本组件**：通过脚本实现的一些相对独立的通用模块功能的组件。这类组件的设计是脚本可重用的关键，需要仔细分析游戏对象中哪些功能可以被独立出来成为一个可重用的功能模块组件，并且在实现上应该尽量降低与其他组件的耦合性。
3. **高层的胶水代码脚本**：这些脚本用来真正将引擎基础组件和模块功能组件组合到一起实现最终游戏对象逻辑。用“胶水代码”来形容这些脚本非常的贴切，就是把所有这些子功能“粘”在一起。

### Unity的架构与ECS架构的区别

可以看出Unity的架构与ECS架构并不一样，虽然在组件-实体这一部分有很大的相似性；

1. Unity的每个组件含有相应的方法，数据与行为并没有实现完全的解耦；
2. Unity没有那么多系统（毕竟Unity只提供最基本的功能而已），系统也并不是只提供行为而已；

### Unity所带的ECS插件包

1. [Entitas插件系统](https://github.com/sschmid/Entitas-CSharp)
2. UnityPackages Managers下的Entities插件包

>注意：实际上，使用哪种架构模式还是得根据具体情况；ECS并不是万能的，局限性[参考这里](https://www.zhihu.com/question/286963885/answer/456710929)

## Reference

1. [守望先锋GDC源视频分享连接](https://www.gdcvault.com/play/1024001/-Overwatch-Gameplay-Architecture-and)（视频）

2. [守望先锋GDC源视频中文翻译](https://gameinstitute.qq.com/community/detail/114516)（文章）

3. [一个ECS系统的介绍及简易实现](https://zhuanlan.zhihu.com/p/30538626)（文章）

4. [一个关于ECS系统的深入理解](https://blog.codingnow.com/2017/06/overwatch_ecs.html)（文章）

5. [Unity3D引擎架构设计](https://www.cnblogs.com/zhibolife/p/3620440.html)（文章）
